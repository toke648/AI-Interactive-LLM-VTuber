<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>éŸ³é¢‘è§£é”æœ€å°ç¤ºä¾‹</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 24px; }
        button { margin-right: 12px; padding: 8px 16px; }
        #log { margin-top: 16px; white-space: pre-wrap; background: #f7f7f7; padding: 12px; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <h2>éŸ³é¢‘è§£é”æœ€å°ç¤ºä¾‹</h2>
    <p>æ­¥éª¤ï¼š</p>
    <ol>
        <li>å…ˆç‚¹â€œå¯ç”¨å£°éŸ³ï¼ˆä¸€æ¬¡ï¼‰â€å®Œæˆæµè§ˆå™¨çš„ç”¨æˆ·æ‰‹åŠ¿è§£é”ã€‚</li>
        <li>éšåç‚¹å‡»â€œæ¨¡æ‹Ÿè½®è¯¢æ’­æ”¾â€å³å¯ç›´æ¥å‡ºå£°ï¼Œä¸å†éœ€è¦æ‰‹åŠ¿ã€‚</li>
    </ol>

    <button id="btnUnlock">å¯ç”¨å£°éŸ³ï¼ˆä¸€æ¬¡ï¼‰</button>
    <button id="btnPlay">æ¨¡æ‹Ÿè½®è¯¢æ’­æ”¾</button>
    <div id="log"></div>

    <script>
    (function(){
        const log = (...args) => {
            const el = document.getElementById('log');
            el.textContent += args.join(' ') + '\n';
        };

        let unlocked = false;
        let audioCtx = null;
        let player = new Audio();
        player.crossOrigin = 'anonymous';
        player.preload = 'auto';
        player.loop = true; // è§£é”é˜¶æ®µæŒç»­æ’­æ”¾
        player.muted = true; // è§£é”é˜¶æ®µé™éŸ³

        function unlockAudio() {
            if (unlocked) {
                log('å·²è§£é”ï¼Œè·³è¿‡');
                return;
            }
            try {
                const dataUrl = 'data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAACcQACcQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA';
                player.src = dataUrl;
                const p1 = player.play().catch(() => {});

                if (!audioCtx) {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                }
                const p2 = audioCtx.resume().then(() => {
                    const buffer = audioCtx.createBuffer(1, 1, audioCtx.sampleRate);
                    const source = audioCtx.createBufferSource();
                    source.buffer = buffer;
                    source.connect(audioCtx.destination);
                    try { source.start(0); } catch (e) {}
                }).catch(() => {});

                Promise.allSettled([p1, p2]).then(() => {
                    unlocked = true;
                    log('ğŸ”“ è§£é”å®Œæˆ (HTMLAudio & WebAudio)');
                });
            } catch (e) {
                log('è§£é”å¼‚å¸¸:', e);
            }
        }

        function playOnce(url) {
            if (!unlocked) {
                log('æœªè§£é”ï¼Œå°è¯•å…ˆè§£é”');
                unlockAudio();
            }
            try {
                player.muted = false;
                player.loop = false;
                player.src = url + '?t=' + Date.now();
                player.play().then(()=>log('å¼€å§‹æ’­æ”¾:', player.src)).catch(err=>log('æ’­æ”¾å¤±è´¥:', err));
            } catch (e) {
                log('æ’­æ”¾å¼‚å¸¸:', e);
            }
        }

        document.getElementById('btnUnlock').addEventListener('click', unlockAudio);
        document.getElementById('btnPlay').addEventListener('click', () => {
            // ä½¿ç”¨ä½ é¡¹ç›®é‡Œå¯è®¿é—®çš„éŸ³é¢‘ï¼Œç¤ºä¾‹ä½¿ç”¨åç«¯è¾“å‡º
            playOnce('http://127.0.0.1:5000/audio/output.mp3');
        });
    })();
    </script>
</body>
</html>



